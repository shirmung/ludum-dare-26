<!DOCTYPE html>

<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>light</title>
        <link rel="stylesheet" href="styles/compiled/style.css" />
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
        <script src="js/crafty.js"></script>
        <script src="js/graphics.js"></script>
        <style>
        html, body {
            background: #222;
        }
        </style>
    </head>

    <body>
        <script type="text/javascript">
            var disabledLights = [];
            var SCREEN_WIDTH = 1000;
            var SCREEN_HEIGHT = 600;

            Crafty.init(1000, 600);

            Crafty.scene('main-menu', function() {
                Crafty.background('#000');
                Crafty.e('HTML')
                    .attr({ w: 1000, h: 20, x: 0, y: 200 })
                    .append('<div id="begin"><button id="begin-button">BEGIN</button></div>');                                     
            });

            Crafty.scene('play-game', function() {
                Crafty.background('url(images/background.png)');
                
                Crafty.e('2D, DOM, Platform, Color')
                    .color('#030408')
                	.attr({ x: 0, y: 500, w: SCREEN_WIDTH, h: SCREEN_HEIGHT - 500 });

                Crafty.e('2D, DOM, Platform, Building, Color, Collision, Solid')
                    .color('rgb(0, 0, 255)')
                	.attr({ x: 300, y: 400, w: 50, h: 100 })
                	.collision();

                Crafty.e('2D, DOM, Platform, Building, Color, Collision, Solid')
                    .color('rgb(0, 0, 255)')
                	.attr({ x: 500, y: 400, w: 100, h: 100 })
                	.collision();

                Crafty.e('2D, DOM, Platform, Building, Color, Collision, Solid')
                    .color('rgb(0, 0, 255)')
                	.attr({ x: 600, y: 300, w: 50, h: 200 })
                	.collision();

                Crafty.e('2D, DOM, Light, Color, Collision')
                    .color('rgb(255, 0, 255)')
                    .attr({ x: 200, y: 400, w: 10, h: 10 })
                    .collision();

                Crafty.e('2D, DOM, Light, Color, Collision')
                    .color('rgb(255, 0, 255)')
                    .attr({ x: 450, y: 450, w: 10, h: 10 })
                    .collision();

                Crafty.c('FollowAI', {
                    followAI: function() {
                        this.bind('EnterFrame', function() {
                            if (disabledLights.length == 0) {
                                if (this.x <= player.x + 5) {
                                    this.x += 2;
                                } else if (this.x >= player.x + 5) {
                                    this.x -= 2;
                                }
                            }
                        });
                    }
                });

                Crafty.c('LightSwitch', {
                    _pressed: false, 

                    lightSwitch: function() {
                        this.requires('Collision')

                        .bind('KeyDown', function(e) {
                            if (e.key == Crafty.keys['SPACE']) {
                                this.pressed = true;
                            }
                        })

                        .bind('Moved', function(from) {
                            if (this.hit('Light') && this.pressed) {
                                var currentLight = this.hit('Light')[0].obj;

                                if (currentLight.color() == 'rgb(255, 0, 255)') {
                                    currentLight.color('rgb(255, 255, 0)');
                                    disabledLights.push(currentLight);
                                } else {
                                    currentLight.color('rgb(255, 0, 255)');
                                    disabledLights.splice(disabledLights.indexOf(currentLight), 1);
                                }

                                this.pressed = false;
                            }
                        });

                        return this;
                    }
                });

                Crafty.c('RunInto', {
                    runInto: function() {
                        this.requires('Collision')

                        this.bind('Moved', function(from) {
                            if (this.hit('Solid')) {
                                this.attr({x: from.x, y: from.y});
                            }
                        })

                        this.bind('EnterFrame', function() {
                            if (this.hit('Enemy') && disabledLights.length == 0) {
                                Crafty.stop();
                                Crafty.e('HTML')
                                    .append('<div style="font-size:40px; color: white">GAME OVER BItCHZ</div>');
                            }
                        });

                        return this;
                    }
                });

                var player = Crafty.e('2D, DOM, ProtagSprite, ProtagAnims, Player, Twoway, Gravity, RunInto, LightSwitch')
                	            .attr({ x: 10, y: 450, w: 32, h: 44 })
                	            .twoway(3, 7)
                	            .gravity('Platform')
                	            .runInto()
                	            .lightSwitch()
                                .ProtagAnims();

                var enemy = Crafty.e('2D, DOM, Enemy, Color, Collision, Gravity, FollowAI')
                                .color('rgb(0, 255, 255)')
                	            .attr({ x: 300, y: 450, w: 10, h: 50 })
                                .collision()
                	            .gravity('Platform')
                	            .followAI();
            });

            //Crafty.scene('main-menu');
            Crafty.scene('play-game');

            $('#begin-button').bind('click', function(){ 
                Crafty.scene('play-game');
            });
        </script>
    </body>
</html>
