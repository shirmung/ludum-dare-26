<!DOCTYPE html>

<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>light</title>
        <link rel="stylesheet" href="styles/compiled/style.css" />
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
        <script src="js/crafty.js"></script>
        <script src="js/raphael.js"></script>
        <script src="js/graphics.js"></script>
        <style>
        html, body {
            background: #222;
        }
        </style>
    </head>

    <body>
        <script type="text/javascript">
            var enemies = [];
            var disabledLights = [];
            var SCREEN_WIDTH = 2000;
            var SCREEN_HEIGHT = 600;

            // height and radius are optional; it's random otherwise
            function makeLight(x, y, height, radius) {
                height = height || Math.floor(Math.random() * 120) + 100;
                radius = radius || Math.floor(Math.random() * 200) + 50;

                var lightCircle = Crafty.e('2D, DOM, CircleShape')
                    .attr({
                        x: x - radius,
                        y: y - height - radius,
                        w: 36 + 2*radius,
                        h: 62 + 2*radius
                    });

                // Sprite for light
                Crafty.e('2D, DOM, LampSprite')
                    .attr({ x: x, y: y - height, w: 36, h: height });

                Crafty.e('2D, DOM, LampSprite, Light, Collision')
                    .attr({ x: x, y: y - height, w: 36, h: 62,
                        lightRadius: radius, on: true, lightCircle: lightCircle })
                    .collision();

                lightCircle.CircleShape();

            }

            Crafty.init(2000, 600);
            Crafty.viewport.init(1000, 600);

            Crafty.scene('main-menu', function() {
                Crafty.background('url(images/title.png) center center no-repeat');
                Crafty.e('HTML')
                    .attr({ w: SCREEN_WIDTH, h: 20, x: 0, y: SCREEN_HEIGHT - 20 })
                    .append('<div id="begin"><button id="begin-button">BEGIN</button></div>');                                     
            });

            Crafty.scene('play-game', function() {
                Crafty.background('url(images/background.png)');

                Crafty.e('2D, DOM, TreeSprite')
                    .attr({ x: 100, y: 400 - 496, w: 2*196, h: 496 });
                
                Crafty.e('2D, DOM, Platform, Color')
                    .color('#030408')
                    .attr({ x: 0, y: 400, w: SCREEN_WIDTH, h: SCREEN_HEIGHT - 400 });

                Crafty.e('2D, DOM, Start, Color, Collision, Solid')
                    .color('rgb(0, 0, 255)')
                    .attr({ x: 0, y: 0, w: 1, h: 600 })
                    .collision();

                Crafty.e('2D, DOM, End, Color, Collision, Solid')
                    .color('rgb(0, 0, 255)')
                    .attr({ x: 2000, y: 0, w: 1, h: 600 })
                    .collision();

                Crafty.e('2D, DOM, Platform, Building, Color, Collision, Solid')
                    .color('#030408')
                    .attr({ x: 300, y: 300, w: 50, h: 100 })
                	.collision();

                Crafty.e('2D, DOM, Platform, Building, Color, Collision, Solid')
                    .color('#030408')
                    .attr({ x: 500, y: 300, w: 100, h: 100 })
                	.collision();

                Crafty.e('2D, DOM, Platform, Building, Color, Collision, Solid')
                    .color('#030408')
                    .attr({ x: 600, y: 200, w: 50, h: 200 })
                	.collision();

                makeLight(200, 400);
                makeLight(450, 400);

                Crafty.c('FollowAI', {
                    _disabled: false,
                    _speed: 0,

                    followAI: function(speed) {
                        this.speed = speed;

                        this.bind('EnterFrame', function() {
                            if (!this.disabled) {
                                if (this.x <= player.x + 5) {
                                    this.x += this.speed;
                                } else if (this.x >= player.x + 5) {
                                    this.x -= this.speed;
                                }
                            }
                        });

                        return this;
                    }
                });

                Crafty.c('LightSwitch', {
                    _touched: false,

                    lightSwitch: function() {
                        this.requires('Collision')

                        .bind('KeyDown', function(e) {
                            if (e.key == Crafty.keys['SPACE'] && this.touched) {
                                var currentLight = this.hit('Light')[0].obj;
                                var lightRadius = currentLight.attr('lightRadius');
                                lightRadius *= lightRadius;

                                if (currentLight.attr('on')) {
                                    currentLight.sprite(36, 0, currentLight.w, currentLight.h);
                                    currentLight.attr({on: false});
                                    currentLight.attr('lightCircle').hide();
                                    disabledLights.push(currentLight);

                                    $.each(enemies, function(index, value) {
                                        var x = value.x - currentLight.x;
                                        var y = value.y - currentLight.y;
                                        if (x * x + y * y <= lightRadius) {
                                            value.disabled = true;
                                        }
                                    });

                                    Crafty.e("2D, DOM, Particles")
                                        .attr({x: currentLight.x + 18, y: currentLight.y + 31})
                                        .particles({
                                            startColour: [200, 179, 162, 1],
                                            startColourRandom: [20, 5, 0, 1],
                                            endColour: [42, 39, 39, 1],
                                            endColourRandom: [0, 0, 0, 1],
                                            angle: 180,
                                            angleRandom: 60,
                                            lifeSpan: 45,
                                            lifeSpanRandom: 15,
                                            maxParticles: 20,
                                            gravity: {x: 0, y: 0.03},
                                            duration: 30
                                        });
                                } else {
                                    currentLight.sprite(0, 0, currentLight.w, currentLight.h);
                                    currentLight.attr({on: true});
                                    currentLight.attr('lightCircle').show();
                                    disabledLights.splice(disabledLights.indexOf(currentLight), 1);

                                    $.each(enemies, function(index, value) {
                                        var x = value.x - currentLight.x;
                                        var y = value.y - currentLight.y;
                                        if (x * x + y * y <= lightRadius) {
                                            value.disabled = false;
                                        }
                                    });
                                }

                                this.switched = false;
                            }
                        })

                        .bind('Moved', function() {
                            if (this.hit('Light')) {
                                 this.touched = true;
                            }
                        });

                        return this;
                    }
                });

                Crafty.c('RunInto', {
                    runInto: function() {
                        this.requires('Collision')

                        this.bind('Moved', function(from) {
                            if (this.hit('Solid')) {
                                this.attr({x: from.x, y: from.y});
                            }

                            if (this.x < from.x) {
                                if (Crafty.viewport.x < 0) {
                                     Crafty.viewport.x += (from.x - this.x)/10;
                                }
                            } else {
                                if (Crafty.viewport.x > -1000) {
                                    Crafty.viewport.x -= (this.x - from.x)/10;
                                }
                            }
                        })

                        this.bind('EnterFrame', function() {
                            if (this.hit('Enemy')) {
                                var currentEnemy = this.hit('Enemy')[0].obj;

                                if (!currentEnemy.disabled) {
                                    Crafty.scene('game-over');
                                }
                            }
                        });

                        return this;
                    }
                });

                var player = Crafty.e('2D, DOM, ProtagSprite, ProtagAnims, Twoway, Gravity, RunInto, LightSwitch, Tween')
                	            .attr({ x: -32, y: 400 - 44, w: 32, h: 44 })
                	            .runInto()
                	            .lightSwitch()
                                .ProtagAnims()
                                .animate('walk_right', 20, -1)
                                .tween({x: 10}, 10);

                setTimeout(function() {
                    // Gravity is here b/c it f's up the animations otherwise.
                    player.stop().gravity('Platform').twoway(3, 7);
                }, 16.66);

                var enemy1 = Crafty.e('2D, DOM, Enemy, Color, Collision, Gravity, FollowAI')
                                .color('rgb(0, 255, 255)')
                                .attr({ x: 300, y: 450, w: 10, h: 50 })
                                .collision()
                                .gravity('Platform')
                                .followAI(2);

                enemies.push(enemy1);

	            var enemy2 = Crafty.e('2D, DOM, Enemy, Color, Collision, Gravity, FollowAI')
                                .color('rgb(0, 255, 255)')
                                .attr({ x: 600, y: 450, w: 10, h: 50 })
                                .collision()
                                .gravity('Platform')
                                .followAI(1);

                enemies.push(enemy2);
            });

            Crafty.scene('game-over', function() {
                Crafty.background('red');
            });

            //Crafty.scene('main-menu');
            Crafty.scene('play-game');

            $('#begin-button').bind('click', function(){ 
                Crafty.scene('play-game');
            });
        </script>
    </body>
</html>
